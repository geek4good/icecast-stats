#!/usr/bin/env ruby

require "fileutils"
require "optparse"

APP_ROOT = File.expand_path("..", __dir__)

def setup
  FileUtils.chdir(APP_ROOT) do
    # This script is a way to set up or update your development environment automatically.
    # This script is idempotent, so that you can run it at any time and get an expectable outcome.

    log "Installing dependencies"
    system! "bundle check || bundle install"

    log "Resetting the development database"
    system! "bin/rails db:reset || bin/rails db:migrate"

    log "Resetting the test database"
    system!({"RAILS_ENV" => "test"}, "bin/rails db:reset || bin/rails db:migrate")

    log "Removing old logs and tempfiles"
    system! "bin/rails log:clear tmp:clear"

    log "All set up"
    log ""
    log "To see the available commands, run:"
    log ""
    log "    bin/setup help"
    log ""
  end
end

def help
  puts "Usage: #{$0}"
  puts ""
  puts "Installs dependencies, resets dev and test databases, and generally"
  puts "prepares the app to be run locally"
  puts ""
  puts "Other useful commands:"
  puts ""
  puts "  bin/dev"
  puts "      # runs app locally"
  puts ""
  puts "  bin/ci"
  puts "      # runs all tests and checks as CI would"
  puts ""
  puts "  bin/rails test"
  puts "      # run non-system tests"
  puts ""
  puts "  bin/rails test:system"
  puts "      # run system tests"
  puts ""
  puts "  bin/setup help"
  puts "      # show this message"
  puts ""
end

# Execute system commands with built-in error checking and logging
def system!(*args)
  log "Executing #{args}"
  if system(*args, exception: true)
    log "#{args} succeeded"
  else
    log "#{args} failed"
    abort
  end
end

# Decorate log output with its origin (the script's name)
def log(message)
  puts "[ bin/setup ] #{message}"
end

skip_server = false

OptionParser.new do |parser|
  parser.on("--skip-server") do
    skip_server = true
  end

  parser.on("-h", "--help") do
    help
    exit
  end
end.parse!

setup
exit if skip_server

puts "\n== Starting development server =="
$stdout.flush # flush the output before exec(2) so that it displays
exec "bin/dev"
